# 综合应用实验 #


史杰，林鹏，颜宇辰

## 一、实验目的  ##

能够综合应用课程所学的技术与工具，包括：

1. Socket通信
2. 多进程、多线程编程
3. 交叉调试目标端程序
4. 磁盘分区与文件系统创建
5. 模块与驱动编程


## 二、实验内容  

1. 将树莓派设为智能家居Linux服务器，可用来采集并维护环境数据，如PM2.5、温度、湿度、气味、电器状态数据等。在实际环境中数据来自相应的传感器，本次试验中用scull设备模拟。

2. 要求创建2个以上的scull设备，设备驱动可选择从内核源码树外(Kbuild)编译安装，或加入到内核源码树内。驱动函数要求包括： open, release, read, write, llseek, ioctl。

3. 实验中的环境数据存储在特定文件系统中。该文件系统要求具备属性：在线写入、持久性、断电可靠性。

4. PC机、移动设备或另外一个树莓派用作远程客户端，随时请求获取环境数据，客户端和服务器之间采用Socket通信。

5. APP编译采用交叉编译，用gdb-gdbserver交叉调试APP。

## 三、实验过程与结果   

### 1. 系统总计架构

智能家居Linux服务器总体架构如图所示：

![avatar](./lab6-picture/pic1.png)
将PC机作为远程客户端，树莓派做服务器，PC机可以随时向树莓派发送请求获取环境数据，采用TCP协议通信的socket编程，scull设备获取PM2.5、温度、湿度等数据后存入文件系统并读取给服务器，服务器将请求的环境数据传送至客户端。

### 2. scull设备安装与应用



### 3. 文件系统


### 4. socket编程

从总体架构图中可以看出，本系统将PC机作为远程客户端，树莓派做服务器，PC机可以随时向树莓派发送请求获取环境数据，采用TCP协议通信的socket编程，scull设备获取PM2.5、温度、湿度等数据后存入文件系统并读取给服务器，服务器将请求的环境数据传送至客户端。
![avatar](./lab6-picture/pic1.png)
 Socket是应用层与TCP/IP协议族通信的中间软件抽象层，它是一组接口。是一种"打开—读/写—关闭"模式的实现，服务器和客户端各自维护一个"文件"，在建立连接打开后，可以向自己文件写入内容供对方读取或者读取对方内容，通讯结束时关闭文件。采用TCP协议通信的socket编程流程见下图

![avatar](./lab6-picture/pic2.png)

其中客户端（PC机）

1. 创建socket
2. 通过调用connect函数建立和服务器的连接
3. 向服务器发送请求环境数据
4. 接受来自服务器的反馈消息
5. 关闭socket

服务器（树莓派）

1. 创建socket
2. 通过bind函数绑定socket和端口号
3. 通过listen函数监听端口号
4. 通过accept接收来自客户端的连接请求
5. 处理来自树莓派的环境数据请求，并向客户端发送数据
6. 关闭socket

## 四、实验总结 总结实验收获 描述未解决的问题  ##
 




## 五、附实验源码 ##
